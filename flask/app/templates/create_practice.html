{% extends "base.html" %}
{% block title %}テーブル作成（CREATE TABLE）{% endblock %}
{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/learning.css') }}">

<style>
/* ===== SQL Editor Window ===== */
.sql-editor-box {
    background: #1e1e1e;
    color: #dcdcdc;
    padding: 20px;
    border-radius: 8px;
    font-family: monospace;
    margin-top: 20px;
    white-space: pre-wrap;
    overflow-x: hidden;
    overflow-y: visible;
}

/* 入力フォーム（白背景） */
.sql-input, 
.sql-col, 
.sql-type, 
.sql-constraint {
    font-family: monospace;
    font-size: 1rem;
    background: #ffffff;
    color: #000000;
    border: 1px solid #555;
    padding: 3px 6px;
    border-radius: 4px;
    max-width: 100%;
    box-sizing: border-box;
}

/* テーブル名入力欄 */
.table-name-input {
    width: 200px !important;
}

/* 行のレイアウト（ここが最大の修正ポイント） */
.sql-line {
    display: flex;
    flex-wrap: nowrap;   /* ← 折り返し禁止 */
    gap: 8px;
    margin-left: 20px;
    width: 100%;
}

/* 入力欄の幅（絶対に縮まないようにする） */
.sql-editor-box input.sql-col {
    width: 260px !important;
    min-width: 260px !important;
    max-width: none !important;
    flex: 0 0 260px !important;
}

.sql-editor-box input.sql-constraint {
    width: 350px !important;
    min-width: 350px !important;
    max-width: none !important;
    flex: 0 0 350px !important;
}

.sql-editor-box select.sql-type {
    width: 160px !important;
    min-width: 160px !important;
    max-width: none !important;
    flex: 0 0 160px !important;
}

/* カンマ */
.comma {
    font-weight: bold;
    color: #dcdcdc;
}

/* カラム削除ボタン */
.delete-col-btn {
    background: #cc3333;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
}
.delete-col-btn:hover {
    background: #aa0000;
}

/* ===== Add Button ===== */
.add-btn {
    margin-top: 10px;
    background: #007bff;
    color: white;
    padding: 8px 14px;
    border-radius: 5px;
    border: none;
    cursor: pointer;
}
.add-btn:hover {
    background: #0056b3;
}

/* ===== History & Table list ===== */
.table-list-box, .history-box {
    background: #fff;
    padding: 16px;
    border-radius: 8px;
    margin-top: 25px;
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.history-item {
    border-bottom: 1px solid #ccc;
    padding: 10px 0;
    font-family: monospace;
}
.history-item:last-child {
    border-bottom: none;
}

.success {
    color: green;
    font-weight: bold;
    text-align: center;
}

.error {
    color: red;
    font-weight: bold;
    text-align: center;
}

/* ボタン配置 */
.center-btn {
    text-align: center;
    margin-top: 10px;
}

/* 2行になる作成ボタン */
.create-btn {
    padding: 12px 25px;
    width: 180px;
    font-size: 1.1rem;
    white-space: normal !important;
    line-height: 1.3;
}
</style>
{% endblock %}

{% block content %}

<h1>テーブル作成（CREATE TABLE）</h1>

<div class="nav-buttons">
    <a href="/part_of_database/create/example" class="prev">◀ 前へ</a>
    <a href="/quiz/create_table" class="next">クイズへ ▶</a>
</div>

{% if message %}
<p class="success">{{ message }}</p>
{% endif %}

{% if error_message %}
<p class="error">{{ error_message }}</p>
{% endif %}

<!-- ==========================================
     SQL 文埋め込み型入力 UI
=========================================== -->
<form method="POST">

<div class="sql-editor-box">
<pre class="sql-display">
CREATE TABLE <input type="text" name="table_name" class="sql-input table-name-input" placeholder="テーブル名" required> (
<div id="column-area">
    <div class="sql-line">
        <input type="text" name="columns[]" class="sql-col" placeholder="カラム名" required>
        <select name="data_types[]" class="sql-type">
            <option value="INT">INT</option>
            <option value="VARCHAR(50)">VARCHAR(50)</option>
            <option value="DATE">DATE</option>
            <option value="BOOLEAN">BOOLEAN</option>
        </select>
        <input type="text" name="constraints[]" class="sql-constraint" placeholder="制約 (例: PRIMARY KEY)">
        <span class="comma">,</span>
        <button type="button" class="delete-col-btn" onclick="deleteColumn(this)">×</button>
    </div>
</div>
);
</pre>
</div>

<button type="button" class="add-btn" onclick="addColumn()">＋ カラム追加</button>

<br>
<div class="center-btn">
    <button type="submit" class="btn create-btn">
        テーブルを<br>作成する
    </button>
</div>

</form>

<!-- ==========================================
     作成済みテーブル一覧
=========================================== -->
<div class="table-list-box">
    <h2>作成済みテーブル一覧</h2>

    {% if tables %}
        <ul>
        {% for t in tables %}
            <li>{{ t[0] }}</li>
        {% endfor %}
        </ul>
    {% else %}
        <p>まだテーブルがありません。</p>
    {% endif %}
</div>

<!-- ==========================================
     CREATE文の履歴（最新10件）
=========================================== -->
<div class="history-box">
    <h2>CREATE文 履歴（最新10件）</h2>

    {% if history %}
        {% for h in history %}
        <div class="history-item">
            <strong>{{ h[0] }}</strong><br>
            {{ h[1] }}<br>
            <span style="font-size:0.8rem; color:#888;">{{ h[2] }}</span>
        </div>
        {% endfor %}
    {% else %}
        <p>履歴がありません。</p>
    {% endif %}
</div>

<div class="nav-buttons">
    <a href="/part_of_database/create/example" class="prev">◀ 前へ</a>
    <a href="/quiz/create_table" class="next">クイズへ ▶</a>
</div>

<script>
/* 最終行のカンマ調整 */
function updateCommas() {
    const lines = document.querySelectorAll("#column-area .sql-line");
    lines.forEach((line, index) => {
        const comma = line.querySelector(".comma");
        if (index === lines.length - 1) {
            comma.style.display = "none";
        } else {
            comma.style.display = "inline";
        }
    });
}

/* カラム行追加 */
function addColumn() {
    const area = document.getElementById("column-area");
    const line = document.createElement("div");
    line.className = "sql-line";

    line.innerHTML = `
        <input type="text" name="columns[]" class="sql-col" placeholder="カラム名" required>
        <select name="data_types[]" class="sql-type">
            <option value="INT">INT</option>
            <option value="VARCHAR(50)">VARCHAR(50)</option>
            <option value="DATE">DATE</option>
            <option value="BOOLEAN">BOOLEAN</option>
        </select>
        <input type="text" name="constraints[]" class="sql-constraint" placeholder="制約 (例: PRIMARY KEY)">
        <span class="comma">,</span>
        <button type="button" class="delete-col-btn" onclick="deleteColumn(this)">×</button>
    `;

    area.appendChild(line);
    updateCommas();
}

/* カラム削除 */
function deleteColumn(btn) {
    const area = document.getElementById("column-area");
    const lines = area.querySelectorAll(".sql-line");

    if (lines.length <= 1) return; /* ← 最後の1行は削除不可 */

    btn.parentElement.remove();
    updateCommas();
}

/* 初期ロード時の調整 */
document.addEventListener("DOMContentLoaded", () => {
    updateCommas();
});
</script>

{% endblock %}
