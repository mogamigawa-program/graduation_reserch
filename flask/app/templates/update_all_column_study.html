{% extends "base.html" %}
{% block title %}全レコード更新の学習ページ{% endblock %}
{% block content %}

<div class="container">
    <div class="nav-buttons">
        <a href="/index/update?flag=min" class="prev">◀ 前へ</a>
        <a href="/basic/update/all-records/example" class="next">次へ ▶</a>
    </div>

    <h1>全レコード更新の体験</h1>

    <p><strong style="color: red;">ここでは、全レコードを更新することの危険性を体験してもらいます！</strong></p>
    <p><strong>警告:</strong> WHERE句がないUPDATE文は全レコードを更新します。実行すると、すべてのレコードが同じ値に更新され、データが失われるリスクがあります。</p>

    {% if error_message %}
        <p style="color: red;">{{ error_message }}</p>
    {% endif %}
    {% if message %}
        <p style="color: green;">{{ message }}</p>
    {% endif %}

    <table class="table-bordered">
        <caption>productsテーブル</caption>
        <thead>
            <tr>
                {% for col in products_desc %}
                    <th>{{ col[0] }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in products_data %}
                <tr>
                    {% for item in row %}
                        <td>{{ item }}</td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <form method="POST" class="btn-container">
        <div id="columns-container">
            <div class="form-group">
                <label>UPDATE products SET</label>
                <select name="column_to_update_0" required>
                    {% for col in products_desc %}
                        <option value="{{ col[0] }}">{{ col[0] }}</option>
                    {% endfor %}
                </select>
                =
                <input type="text" name="new_value_0" placeholder="新しい値" required>
            </div>
        </div>

        <button type="button" class="btn" onclick="addColumn()">カラムを追加</button>
        
        <button type="submit" name="button_val" value="update_all_records_btn" class="btn btn-primary">
            全レコード更新を実行
        </button>
        <button type="submit" name="button_val" value="table_init_btn" class="btn btn-secondary" onclick="return handleReset()">
            テーブルを初期状態に戻す
        </button>
    </form>

    <div class="nav-buttons">
        <a href="/index/update?flag=min" class="prev">◀ 前へ</a>
        <a href="/basic/update/all-records/example" class="next">次へ ▶</a>
    </div>
</div>

<script>
    let columnIndex = 1;

    function addColumn() {
        const container = document.getElementById('columns-container');
        const newField = document.createElement('div');
        newField.className = 'form-group';
        newField.innerHTML = `
            <label>SET</label>
            <select name="column_to_update_${columnIndex}" required>
                {% for col in products_desc %}
                    <option value="{{ col[0] }}">{{ col[0] }}</option>
                {% endfor %}
            </select>
            =
            <input type="text" name="new_value_${columnIndex}" placeholder="新しい値" required>
        `;
        container.appendChild(newField);
        columnIndex++;
    }

    function handleReset() {
        const inputs = document.querySelectorAll('#columns-container input, #columns-container select');
        inputs.forEach(input => input.removeAttribute('required'));
        return true;
    }
</script>

{% endblock %}
